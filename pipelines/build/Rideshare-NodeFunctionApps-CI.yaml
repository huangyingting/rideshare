name: $(BuildDefinitionName) - $(date:yyyyMMdd)$(rev:.r)

trigger:
  branches:
    include:
    - main
  paths:
    include:
    - nodejs/**

stages:
- stage: Build
  displayName: Build stage
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: ubuntu-latest
      demands: npm
    steps:
    - task: Npm@1
      displayName: 'npm install'
      inputs:
        workingDir: 'nodejs/serverless-microservices-functionapp-triparchiver'
        verbose: false
    - task: DeleteFiles@1
      displayName: 'Delete node_modules'
      inputs:
        SourceFolder: 'nodejs/serverless-microservices-functionapp-triparchiver'
        Contents: 'node_modules'
    - task: CopyFiles@2
      displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)/NodeFunctionApp'
      inputs:
        SourceFolder: 'nodejs/serverless-microservices-functionapp-triparchiver'

        TargetFolder: '$(Build.ArtifactStagingDirectory)/NodeFunctionApp'
    - task: ArchiveFiles@1
      displayName: 'FunctionApp Archive'
      inputs:
        rootFolder: '$(Build.ArtifactStagingDirectory)/NodeFunctionApp'
        includeRootFolder: false
        archiveFile: '$(Build.ArtifactStagingDirectory)/NodeFunctionApp.zip'
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: drop'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/NodeFunctionApp.zip'


- stage: Deploy
  displayName: Deploy stage
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: Deploy
    displayName: Deploy
    pool:
      vmImage: $(vmImageName)
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureFunctionApp@1
            displayName: 'Azure Functions App Deploy: RideshareCSTripArchiver'
            inputs:
              azureSubscription: 'YTHUANG(Isolated) (b99b5b7c-8c21-4203-863a-84cce54de7c0)'
              appType: functionApp 
              appName: 'RideshareCSTripArchiver'
              package: '$(Pipeline.Workspace)/drop/NodeFunctionApp.zip'
              deploymentMethod: 'auto'
